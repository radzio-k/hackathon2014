<!DOCTYPE html>
<html>
<head>

<link rel="stylesheet"
	href="http://dojotoolkit.org/reference-guide/1.9/_static/js/dojo/../dijit/themes/claro/claro.css">
<script type="text/javascript"
	src="http://openlayers.org/api/OpenLayers.js"></script>
<script src="http://maps.google.com/maps/api/js?v=3&amp;sensor=false"
	type="text/javascript"></script>
<style type="text/css">
.transactionRecord {
	border: 1px;
	margin: 1em;
}

.offerRecord {
	border: 1px;
}

.employeeName {
	color: blue;
}

.specialEmployeeName {
	color: red;
}

.titleClass {
	color: blue;
}

.tundra .dijitSelect .dijitButtonText {
	text-align: left;
}

.tundra .dijitSelectLabel {
	width: 120px;
	overflow: hidden;
}

</style>
<script>
	dojoConfig = {
		parseOnLoad : true
	}
</script>
<script
	src='http://dojotoolkit.org/reference-guide/1.9/_static/js/dojo/dojo.js'></script>

<script>
	require([ "dijit/form/Select", "dojo/domReady!" ], function() {

	});
</script>
<script>
	// **************************************
	// ****** TRANSACTION RECORD COMPONENT
	// **************************************
	require(
			[ "dojo/_base/declare", "dojo/parser", "dojo/ready",
					"dijit/_WidgetBase", "dijit/_TemplatedMixin", "dojo/dom",
					"dojo/parser", "dojox/widget/Standby", "dijit/registry"],
			function(declare, parser, ready, _WidgetBase, _TemplatedMixin) {

				declare(
						"TransactionRecord",
						[ _WidgetBase, _TemplatedMixin ],
						{
							templateString : "<div class='transactionRecord'>"
									+ "<div><span data-dojo-attach-point='descNode'></span> <span data-dojo-attach-point='dateNode'></span></div>"
									+ "<div>Country : <span data-dojo-attach-point='countryNode'></span></div>"
									+ "<div>City : <span data-dojo-attach-point='cityNode'></span></div>"
									+ "<div>Debit Currency: <span data-dojo-attach-point='debitCurrencyNode'></span></div>"
									+ "<div>Payment: <span data-dojo-attach-point='paymentAmountNode'></span> <span data-dojo-attach-point='paymentCurrencyNode'></span></div>"
									
									+ "<div>Fee : <span data-dojo-attach-point='feeAmountNode'></span>  <span data-dojo-attach-point='feeCurrencyNode'></span></div>"
									+ "</div>",
							// Attributes
							Desc : "unknown",
							_setDescAttr : {
								node : "descNode",
								type : "innerHTML"
							},

							DebitCurrency : "unknown",
							_setDebitCurrencyAttr : {
								node : "debitCurrencyNode",
								type : "innerHTML"
							},

							PaymentCurrency : "unknown",
							_setPaymentCurrencyAttr : {
								node : "paymentCurrencyNode",
								type : "innerHTML"
							},
							PaymentAmount : "unknown",
							_setPaymentAmountAttr : {
								node : "paymentAmountNode",
								type : "innerHTML"
							},

							Date : "unknown",
							_setDateAttr : {
								node : "dateNode",
								type : "innerHTML"
							},

							DescClass : "employeeName",
							_setDescClassAttr : {
								node : "descNode",
								type : "class"
							},

							City : "unknown",
							_setCityAttr : {
								node : "cityNode",
								type : "innerHTML"
							},
							Country : "unknown",
							_setCountryAttr : {
								node : "countryNode",
								type : "innerHTML"
							},
							FeeAmount : "unknown",
							_setFeeAmountAttr : {
								node : "feeAmountNode",
								type : "innerHTML"
							},
							FeeCurrency : "unknown",
							_setFeeCurrencyAttr : {
								node : "feeCurrencyNode",
								type : "innerHTML"
							}
						});

			});
</script>
<script>
	function getAccounts() {
		require([ "dojo/_base/xhr", "dojo/dom", "dojo/_base/array",
				"dojo/domReady!", "dijit/registry", "dojo/parser" ], function(xhr, dom, array) {
			dijit.registry.byId("accountSelectDivStandBy").show();
			// Keep hold of the container node
			var containerNode = dom.byId("debug");

			// Using xhr.get, as we simply want to retrieve information
			xhr.get({
				// The URL of the request
				url : "/hkth-rest-api/a/accounts",
				// Handle the result as JSON data
				handleAs : "json",
				// The success handler
				load : function(jsonData) {
					var accountSelect = dijit.byId('accountSelect');
					array.forEach(jsonData, function(record) {
						// Create our widget and place it
						accountSelect.addOption({
							"label" : record.desc + " " + record.accountNum,
							"value" : record.id
						});
					});
					dijit.registry.byId("accountSelectDivStandBy").hide();
					getPayments();
				},
				// The error handler
				error : function(e) {
					containerNode.innerHTML = e;
					dijit.registry.byId("accountSelectDivStandBy").hide();
				}
			});

		});
	}

	function getPayments() {
		require(
				[ "dojo/_base/xhr", "dojo/dom", "dojo/_base/array",
						"dojo/domReady!" ],
				function(xhr, dom, array) {
					dijit.registry.byId("transactionsPanelStandBy").show();
					dijit.registry.byId("offersPanelStandBy").show();
					dijit.registry.byId("mapStandBy").show();
					// Keep hold of the container node
					var containerNode = dom.byId("debug");
					
					// Using xhr.get, as we simply want to retrieve information
					xhr
							.get({
								// The URL of the request
								url : "/hkth-rest-api/p/payments",
								// Handle the result as JSON data
								handleAs : "json",
								// The success handler
								load : function(jsonData) {
									dom.byId("transactionFee").innerHTML = "HSBC may propose you product that saves "
											+ jsonData.txFeeOptimisationSum
											+ " on transaction fees";
									dom.byId("transferRate").innerHTML = "HSBC may propose you product that saves "
											+ jsonData.txFxOptimisationSUm
											+ " on currency exchange rates";

									dojo.empty("transactionsPanel");
									var transactionPanel = dom
											.byId("transactionsPanel");
									array
											.forEach(
													jsonData.payments,
													function(record) {
														// Create our widget and place it
														var widget = new TransactionRecord(
																{
																	Desc : record.Desc,
																	DebitCurrency : record.TxnDetails.debitAcctCcy,
																	PaymentCurrency : record.TxnDetails.paymentCcy,
																	Date : record.Date,
																	PaymentAmount : record.TxnDetails.txnAmt.amt,
																	City : record.PyeeInfo.pyeeDetlInfo.pyeeDetlInfo.pyeeAddr.city,
																	Country : record.PyeeInfo.pyeeDetlInfo.pyeeDetlInfo.pyeeAddr.prov,
																	FeeAmount : record.ChrgType.Fee.amt,
																	FeeCurrency : record.ChrgType.Fee.ccy
																})
																.placeAt(transactionPanel);
														draw(widget.City, widget.Country, widget.PaymentAmount, widget.FeeAmount, widget.PaymentCurrency);

													});
									dijit.registry.byId("transactionsPanelStandBy").hide();
									dijit.registry.byId("offersPanelStandBy").hide();
									dijit.registry.byId("mapStandBy").hide();
								},
								// The error handler
								error : function(e) {
									containerNode.innerHTML = e;
									dijit.registry.byId("transactionsPanelStandBy").hide();
									dijit.registry.byId("offersPanelStandBy").hide();
									dijit.registry.byId("transactionsPanelStandBy").hide();
									dijit.registry.byId("mapStandBy").hide();
									
								}
							});

				});
	}
</script>
<script>
	require([ "dojo/ready" ], function(ready) {
		ready(function() {
			var accountSelect = dijit.byId('accountSelect');
			getAccounts();

			accountSelect.onChange = function() {
				removeCharts ();
				getPayments();
			}
		});
	});
</script>
<script>
var map;
var drawn = false;
var radius = [60,100,120];
//var chartData = [[10000, 9200, 11811, 7662], [10000, 4000, 11811, 6000, 17662], [14000, 10200, 5000]];

var chartLayers = [];
function draw(city, country, payment, fee, currency)
{

	
	var chartData = [parseFloat(payment), parseFloat(payment)-parseFloat(fee)]
	if (payment <= 100)
		var radius = 60;
	else if (payment <= 1000)
		var radius = 90;
	else 
		var radius = 120;
	
	var location = city + ", " + country;
	
	var geocoderRequest = {address : location}; 
	
	var text = ["You paid " + payment + " " + currency + " paying " + fee + " " + currency + " of fee.", "You could paid only " + (payment-fee) + " " + currency + ", saving " + fee + " " +currency +"." ];
	
	require([ "dojo/ready", "dojo/dom-construct", "dojo/dom",
			"dojo/_base/window", "dojox/geo/openlayers/Map",
			"dojox/geo/openlayers/Layer", "dojox/geo/openlayers/WidgetFeature",
			"dojox/charting/widget/Chart", "dojox/charting/widget/Chart2D",
			"dojox/charting/plot2d/Pie", "dojox/charting/themes/Claro",
			"dojox/charting/action2d/Tooltip",
			"dojox/charting/action2d/MoveSlice", "dojo/on", 
			"dojo/_base/array"], function(ready,
			domConstruct, dom, win, Map, Layer, WidgetFeature, Chart, Chart2D,
			Pie, claro, Tooltip, MoveSlice, on, array) {

		//ready(function() {
			var geocoder = new google.maps.Geocoder();
						
			
				geocoder.geocode(geocoderRequest, function(results, status) {
					if (status == "OK") {
						var a = results[0].geometry.location.A;
						var k = results[0].geometry.location.k;
						paintChart(chartData, a, k, radius, text);
					}
				});
			
			

			

			claro.chart.fill = "transparent";
			claro.chart.stroke = {
				color : "transparent"
			};

			// create a map widget and place it on the page.
			if (! drawn)
			{
				map = new Map("map", {
					baseLayerType : dojox.geo.openlayers.BaseLayerType.GOOGLE
				});
	
				var start = {
					latitude : 48.1351253,
					longitude : 11.58198059
				};
				map.fitTo({
					position : [ start.longitude, start.latitude ],
					extent : 9
				});
	
				var div = domConstruct.create("div", {}, win.body());
			}
			drawn = true;
			
			
			
			
			
			function paintChart(chartData, longitude, latitude, radius, text) {
				// Create the chart within it's "holding" node
				var chart = new Chart2D("chartNode");
				var c = chart.chart;

				c.setTheme(claro);
				c.addPlot("default", {
					type : "Pie",
					markers : true,
					fontColor: "transparent",
				});

				c.addAxis("x");
				c.addAxis("y", {
					min : 5000,
					max : 30000,
					vertical : true,
					fixLower : "major",
					fixUpper : "major"
				});

				// Add the series of data
				c.addSeries("A", chartData);
				
				
				
				// Create the tooltip
				var tip = new Tooltip(c, "default", {
					text: function(o){
				          return text[o.index];
				       }
				});
				
				
				       
				
				
				// Create the slice mover
				var mag = new MoveSlice(c, "default");

				var descr = {
					longitude : longitude,
					latitude : latitude,
					widget : chart,
					width : radius,
					height : radius
				};
				feature = new WidgetFeature(descr);

				layer = new Layer();
				layer.addFeature(feature);
				map.addLayer(layer);
				chartLayers.push(layer);
				// fit to New York with 0.1 degrees extent

				c.surface.rawNode.childNodes[1].setAttribute('fill-opacity',
						'0');
				c.surface.rawNode.childNodes[2].setAttribute('stroke-opacity',
						'0');
				c.surface.rawNode.childNodes[3].setAttribute('fill-opacity',
						'0');

			}

		//});
	});
}

function removeCharts () {
	if (chartLayers.length) {
		for (i = 0; i < chartLayers.length; i++)
		{
			map.removeLayer(chartLayers[i]);
		}
		chartLayers = [];
	}
}
</script>
</head>
<body class="claro">
	<div style="border: solid black 1px; width: 1200px;">
		<div data-dojo-type="dijit/TitlePane"
			data-dojo-props="title: 'Abroad Payments'">
			<table>
				<tr>
					<td width="300px">
						<div data-dojo-type="dijit/layout/ContentPane">
							<div data-dojo-type="dijit/layout/ContentPane" align="left">
								<div style="font-size: 18px;" >Select Account:</div>
								<div id="accountSelectDiv"><select id="accountSelect"
									name="accountSelect" data-dojo-type="dijit/form/Select"
									style="width: 300px;">
								</select></div>
								<div id="accountSelectDivStandBy" data-dojo-type="dojox/widget/Standby" data-dojo-props="target:'accountSelectDiv'"></div>
							</div>
							<div style="font-size: 18px;" align="left">Payments:</div>
							<div data-dojo-type="dijit/layout/ContentPane"
								id="transactionsPanel" align="left"></div>
							<div id="transactionsPanelStandBy" data-dojo-type="dojox/widget/Standby" data-dojo-props="target:'transactionsPanel'"></div>
						</div>
					</td>
					<td width="800px">
						<div data-dojo-type="dijit/layout/ContentPane"
							data-dojo-props="region:'right'" style="float:top; top:20px;">
							<div data-dojo-type="dijit/layout/ContentPane" id="offersPanel" style="float:top; top:20px;">
								<div id="transactionFee"></div>
								<div id="transferRate"></div>
							</div>
							<div id="offersPanelStandBy" data-dojo-type="dojox/widget/Standby" data-dojo-props="target:'offersPanel'"></div>
							<br/>
							<br/>
							<div data-dojo-type="dijit/layout/ContentPane" id="map" style="float:top; background-color: #b5d0d0; width: 800px; height: 400px; border: 2px solid black; "></div>
							<div id="mapStandBy" data-dojo-type="dojox/widget/Standby" data-dojo-props="target:'map'"></div>
						</div>
					</td>
				</tr>
			</table>
		</div>
	</div>
	<div id="debug"></div>
</body>
</html>